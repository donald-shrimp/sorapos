<html>

<head>
  <meta charset="utf-8">
  <title>SORA POS</title>
  <script src="./jsQR.js"></script>
  <!-- <script src="./modal.js"></script> -->
  <link href="https://fonts.googleapis.com/css?family=Ropa+Sans" rel="stylesheet">
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="modal.css">
</head>

<body>

  <div id="easyModal" class="modal">
    <div class="modal-content">
      <div class="modal-border">
        <div class="modal-header">
          <h1>èª­ã¿å–ã‚Šçµæœ</h1>
        </div>
        <div id="modal-body">

        </div>
        <div id="modal-footer">
          <button class="modalClose">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="add_to_cart" class="modalClose">æ¬¡ã¸</button>
        </div>
      </div>
    </div>
  </div>

  <h1>SORA POS</h1>
  <p>QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚</p>
  <div id="loadingMessage">ğŸ¥ ã‚«ãƒ¡ãƒ©ã«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã¾ã›ã‚“ğŸ˜¥ï¼ˆã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</div>
  <canvas id="canvas" hidden></canvas>
  <div id="output" hidden>
    <div id="outputMessage">No QR code detected.</div>
    <div hidden><b>Data:</b> <span id="outputData"></span></div>
  </div>
  <button id="buy">è³¼å…¥</button>
  <script>
    var video = document.createElement("video");
    var canvasElement = document.getElementById("canvas");
    var canvas = canvasElement.getContext("2d");
    var loadingMessage = document.getElementById("loadingMessage");
    var outputContainer = document.getElementById("output"); 11
    var outputMessage = document.getElementById("outputMessage");
    var outputData = document.getElementById("outputData");
    var modalbody = document.getElementById("modal-body");
    var addtocart = document.getElementById("add_to_cart");
    var buybutton = document.getElementById("buy");
    var total_amount = 0;//åˆè¨ˆé‡‘é¡
    var items_data = [];//å•†å“æƒ…å ±ã‚’ãã£ã¤ã‘ãŸã‚‚ã®
    var json = JSON;
    var wallet = JSON;//ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã®æƒ…å ±
    console.log(json);
    const sleep = waitTime => new Promise(resolve => setTimeout(resolve, waitTime));

    function drawLine(begin, end, color) {
      canvas.beginPath();
      canvas.moveTo(begin.x, begin.y);
      canvas.lineTo(end.x, end.y);
      canvas.lineWidth = 4;
      canvas.strokeStyle = color;
      canvas.stroke();
    }

    // ã‚«ãƒ¡ãƒ©ç”»åƒã®å–å¾— ã‚¹ãƒãƒ›ã®å ´åˆã¯å¤–ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
      video.srcObject = stream;
      video.setAttribute("playsinline", true); // iOSã®safariã«ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§ãªã„ã“ã¨ã‚’ä¼ãˆã‚‹ãŸã‚ã«å¿…è¦ãªã‚‚ã®
      video.play();
      requestAnimationFrame(tick);
    });


    const modal = document.getElementById('easyModal');
    const buttonClose = document.getElementsByClassName('modalClose')[0];
    function modalOpen() {
      modal.style.display = 'block';
    }

    // ãƒãƒ„å°ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
    buttonClose.addEventListener('click', modalClose);
    function modalClose() {
      modal.style.display = 'none';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä»¥å¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
    addEventListener('click', outsideClose);
    function outsideClose(e) {
      if (e.target == modal) {
        modal.style.display = 'none';
      }
    }

    //ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ãŸã¨ãã®å‹•ä½œ
    addtocart.addEventListener('click', addToCart);

    function addToCart() {
      //åˆè¨ˆé‡‘é¡ã‚’ã¸ã‚“ã“ã†
      total_amount += Number(json.price);
      items_data.push(json);
      console.log("è¿½åŠ æˆåŠŸã€€é‡‘é¡ï¼š" + total_amount);
      console.log(items_data);
      modalClose();
    }

    //è³¼å…¥ãƒœã‚¿ãƒ³ãŒæŠ¼ä¸‹ã•ã‚ŒãŸã¨ãã®å‹•ä½œ
    buybutton.addEventListener('click', buy);
    function buy() {
      console.log("å‘¼ã‚“ã ï¼Ÿby buy");
      if (total_amount < 0 || wallet.wallet_key == null) {
        console.log("total:" + total_amount + "key:" + wallet.wallet_key);
        alert("ãªã‚“ã‹ãŸã‚Šã²ã‚“ã§");

      }
      //ã‚³ãƒãƒ³ãƒ‰ã®æ–‡å­—åˆ—ã‚’ç·¨é›†ï¼ˆç¾çŠ¶ã¯ã“ã®å‹•ãã§ã„ã„ã‚„ï¼‰
      //const command = "{\"jsonrpc\":\"1.0\", \"method\":\"sendmoney\",\"params\":[\"" + wallet.wallet_key + "\", [{\"address\":\"netw12TDXq8r1C4o9EFbsJGhvamTKm1GkdgReek2PJZLm8fmvmD\", \"amount\":" + total_amount + ", \"message\":\"" + JSON.stringify(wallet) + "," + JSON.stringify(items_data) + "\"}]]}\' -H \'content-type: text/plain;\'";
      const command = "{\"jsonrpc\":\"1.0\", \"method\":\"getbalancedetail\"}";
      //ã‚³ãƒãƒ³ãƒ‰ã‚’ã¶ã‚“æŠ•ã’ã‚‹
      console.log(command);

      fetch('http://127.0.0.1:8000/', {
        mode: 'cors',
        method: 'POST', // or 'PUT'
        headers: {
          'Content-Type': 'application/json',
        },
        body: command,
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
        })
        .catch((error) => {
          console.error('Error:', error);
        });

      //ãã®ã†ã¡ã€€å„JSONã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã«æŠ•ã’ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ­£ã—ã„é€é‡‘å…ˆã‚’æŒ‡å®šï¼ˆä½™åŠ›ãŒã§ããŸã‚‰ãã†ã„ã†å‹•ãã«ã—ã¾ã™ï¼‰
    }

    async function tick() {
      loadingMessage.innerText = "âŒ› Loading video..."
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        loadingMessage.hidden = true;
        canvasElement.hidden = false;
        outputContainer.hidden = false;

        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;

        // QRã‚³ãƒ¼ãƒ‰ã®æ¤œå‡ºãƒ»ãƒ‡ã‚³ãƒ¼ãƒ‰
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        // codeã«QRã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹å‡¦ç†çµæœ(ä½ç½®ã‚„ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœãªã©)ã‚’æ ¼ç´ãƒ»ä½•ã‚‚ãªã‘ã‚Œã°null
        // code.dataã«ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœã‚’æ ¼ç´
        var code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });


        if (code) {
          drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
          drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
          drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
          drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
          outputMessage.hidden = true;
          outputData.parentElement.hidden = false;
          outputData.innerText = code.data;
          //QRä¸€ã¤èª­ã¿è¾¼ã‚“ã ã‚‰ä¸€æ—¦èª­ã¿è¾¼ã¿åœæ­¢
          //jsonå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
          try {
            json = JSON.parse(code.data);
            //å¯¾å¿œã—ãŸQRã‹ã‚’åˆ¤å®šãƒ»ãã†ã§ãªã‘ã‚Œã°èª­ã¿è¾¼ã¿å†é–‹(ãã†ã§ãªã„ã¨ãã¯ãã‚Œã‚’é€šçŸ¥)
            if (json.data_flag == "item") {
              console.log("ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ");
              console.log(json);
              var test = 100 + Number(json.price);
              console.log(test);
              //è³å‘³æœŸé™ãªã©ã®åˆ¤å®šãƒ»å•é¡Œãªã‘ã‚Œã°æ¬¡
              //å¾Œã§ä½œã‚‹

              //æ–‡å­—åˆ—ã‚’å¤‰æ•°ã«æ‰“ã¡è¾¼ã‚€
              modalbody.innerHTML = "å•†å“åï¼š" + json.item_name + "<br>ä¾¡æ ¼ï¼š" + json.price + "<br>è³å‘³æœŸé™ï¼š" + json.consumed_period;
              //èª­ã¿è¾¼ã‚“ã å•†å“åãƒ»ä¾¡æ ¼ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
              modalOpen();
              // requestAnimationFrame(tick);ã‚’ã¨ã‚ã‚‹ã‚„ã¤ã‚’å¾Œã§æ›¸ã
              await sleep(3000);

            } else if (json.data_flag == "wallet") {
              wallet = json;
              //æ–‡å­—åˆ—ã‚’å¤‰æ•°ã«æ‰“ã¡è¾¼ã‚€
              modalbody.innerHTML = "keyï¼š" + wallet.wallet_key;
              //èª­ã¿è¾¼ã‚“ã å•†å“åãƒ»ä¾¡æ ¼ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
              modalOpen();
            } else {
              outputData.innerText = "ä¸æ­£ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚";
              await sleep(2000);
              requestAnimationFrame(tick);
            }
          } catch (e) {
            outputData.innerText = "jsonã§ã¯ã‚ã‚Šã¾ã›ã‚“";
            await sleep(2000);
            requestAnimationFrame(tick);
          }


          //ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‹ã‚‰nç§’çµŒã£ãŸã‚‰èª­ã¿å–ã‚Šå†é–‹

        } else {
          outputMessage.hidden = false;
          outputData.parentElement.hidden = true;
        }
      }
      requestAnimationFrame(tick);
    }

  </script>
</body>

</html>